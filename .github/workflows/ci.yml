name: CI Pipeline for Titanic Analysis

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Create and run simple test
      run: |
        # Создаем простой тестовый файл
        cat > test_ci.py << 'EOF'
        import sys
        import os
        sys.path.append(os.getcwd())
        
        try:
            from src.titanic_app import TitanicAnalysis
            print("✅ Импорт TitanicAnalysis - УСПЕХ")
        except ImportError as e:
            print(f"❌ Ошибка импорта: {e}")
            sys.exit(1)
            
        import pandas as pd
        
        # Создаем тестовые данные
        data = {
            'PassengerId': [1, 2, 3],
            'Survived': [1, 0, 1],
            'Pclass': [1, 3, 2],
            'Sex': ['female', 'male', 'female'],
            'Fare': [50.0, 10.0, 30.0]
        }
        df = pd.DataFrame(data)
        df.to_csv('test_data.csv', index=False)
        
        # Тестируем класс
        analyzer = TitanicAnalysis('test_data.csv')
        assert len(analyzer.df) == 3, f"Ожидалось 3 строки, получено {len(analyzer.df)}"
        
        # Тестируем фильтрацию
        filtered = analyzer.filter_data(sex='female')
        assert len(filtered) == 2, f"Ожидалось 2 женщины, получено {len(filtered)}"
        
        print("✅ Все тесты прошли успешно!")
        EOF
        
        # Запускаем тест
        python test_ci.py

    - name: Clean up
      run: |
        rm -f test_data.csv test_ci.py
